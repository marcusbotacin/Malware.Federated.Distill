import lief
import pandas as pd
from nfs.attribute_extractor import PEAttributeExtractor
import zipfile
import os, sys
from nfs.train_classifier import JSONAttributeExtractor, NeedForSpeedModel
from sklearn.ensemble import RandomForestClassifier
import _pickle as cPickle
import gzip
import tempfile

THRESHOLD = 0.75
label_dict = {"-g" : 0, "-m" : 1}


if len(sys.argv)!=3:
	print("Usage: python %s -m <dir>" % sys.argv[0])
	print("Usage: python %s -g <dir>" % sys.argv[0])
	sys.exit(0)

label = label_dict[sys.argv[1]]
input_dir = sys.argv[2]
output_file = os.path.join(input_dir,"features.cpkl")

train_data = []
for _file in os.listdir(input_dir):
	filepath = os.path.join(input_dir,_file)
	try:
		pe_att_ext = PEAttributeExtractor(open(filepath,'rb').read())
		atts = pe_att_ext.extract()
		atts['label'] = label
		train_data.append(atts)
	except:
		pass

print("Saving to %s" % output_file)
training_data = pd.DataFrame(train_data)
with gzip.open(output_file, 'wb') as fp:
	cPickle.dump(train_data, fp)

